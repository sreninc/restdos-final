{% extends "bases/base-website.html" %}

{% block extra_title %}Signup{% endblock %}

{% block body %}
<!-- Hero section -->
<div class="relative">
    <div class="absolute inset-x-0 bottom-0 h-1/2 bg-gray-100"></div>
    <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
      <div class="relative shadow-xl sm:rounded-2xl sm:overflow-hidden">
        <div class="absolute inset-0">
          <img class="h-full w-full object-cover" src="https://images.unsplash.com/photo-1546195643-70f48f9c5b87?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80" alt="People working on laptops">
          <div class="absolute inset-0 bg-gradient-to-r from-purple-800 to-indigo-700 mix-blend-multiply"></div>
        </div>
        <div class="relative px-4 py-16 sm:px-6 sm:py-24 lg:py-32 lg:px-8">
          <h1 class="text-center text-4xl font-extrabold tracking-tight sm:text-5xl lg:text-6xl">
            <span class="block text-white">Signup</span>
          </h1>
          <p class="mt-6 max-w-lg mx-auto text-center text-xl text-indigo-200 sm:max-w-3xl">
            You are one step away from joining! Enjoy 30 days money back guarantee, no lengthy contract and all our wonderful features.
          </p>
        </div>
      </div>
    </div>
  </div>

<div class="bg-gray-100 pb-12">
<div class="w-1/3 mx-auto">
    <form action="{% url 'signup' signup_plan signup_monthly %}" method="POST" id="signup-form" class="divide-y divide-gray-200">
        {% csrf_token %}
        <div class="space-y-8 divide-y divide-gray-200">
          <div>
            <div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4">
      
              {% crispy signup_form %}
              <hr>
              <div id="card-element"></div>
              <div id="card-errors" role="alert"></div>
            </div>
          </div>
        </div>

        <div class="mt-3 text-sm text-grey-200">
            <p>By clicking Signup you agree to our <a class="text-blue-500 font-medium underline">Terms & Conditions</a> for the {{ signup_plan }} plan. You will be charged â‚¬{{ signup_monthly }} today and the same amount each month thereafter to continue your service.</p>
        </div>
      
        <div class="pt-5">
          <div class="flex justify-end">
            <button type="reset" form="signup-form"
              class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Reset
            </button>
            <button type="submit" form="signup-form" id="submit-button"
              class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Signup
            </button>
          </div>
        </div>
      </form>

      
</div>
</div>

{% endblock %}

{% block postloadjs %}
{{ block.super }}
{{ stripe_public_key|json_script:"id_stripe_public_key" }}
{{ client_secret|json_script:"id_client_secret" }}

<script>
    var stripePublicKey = document.getElementById('id_stripe_public_key').innerHTML.slice(1,-1);
    var clientSecret = document.getElementById('id_client_secret').innerHTML.slice(1,-1);
    var stripe = Stripe(stripePublicKey);
    var elements = stripe.elements();
    var style = {
      base: {
        color: '#000',
        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: 'antialiased',
        fontSize: '16px',
        '::placeholder': {
          color: '#aab7c4'
        }
      },
      invalid: {
        color: '#dc3545',
        iconColor: '#dc3545'
      }
    };
    var card = elements.create('card', { style: style });
    card.mount('#card-element');
  
    // ERROR CHECKING STRIPE
    card.addEventListener('change', function (event) {
      var errorDiv = document.getElementById('card-errors');
      if (event.error) {
        var html = `
        <span class="icon" role="alert">
            <i class="fas fa-times"></i>
        </span>
        <span>${even.error.message}</span>
        `;
        errorDiv.innherHTML = html;
        console.log('card error');
      } else {
        errorDiv.textContent = '';
        console.log('no card error');
      }
    });
  
  
    // PAYMENT INTENT WITHIN STRIPE
    var form = document.getElementById('signup-form');
    console.log(form);
  
    form.addEventListener('submit', function (ev) {
      ev.preventDefault();
      console.log('button pressed');
      card.update({ 'disabled': true});
      document.getElementById('submit-button').disabled = true;
      stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: card,
        }
      }).then(function (result) {
        if (result.error) {
          var errorDiv = document.getElementById('card-errors');
          var html = `
          <span class="icon" role="alert">
              <i class="fas fa-times">error</i>
          </span>
          <span>${result.error.message}</span>
        `;
          errorDiv.innerHTML = html;
          card.update({ 'disabled': false});
          document.getElementById('submit-button').disabled = false;
          console.log(result.error.message);
        } else {
          if (result.paymentIntent.status === 'succeeded') {
            form.submit();
          }
        }
      });
    });
  </script>
{% endblock %}